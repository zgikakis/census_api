# Retrieves import data from U.S. Census International Trade Data API and converts to pandas dataframe
# In Variables section: Specify years, 10 digit HS codes, and fields to retreive 
# Available fields - https://api.census.gov/data/timeseries/intltrade/imports/hs/variables.json
# Request free API key from census.gov if making > 500 API calls per day
# Accepts 10 digit HS codes


import requests
import pandas as pd


# Variables
years = [2022,2023] # list of years. CY2023 is last complete year
fields = "I_COMMODITY,I_COMMODITY_SDESC,I_COMMODITY_LDESC,CTY_CODE,CTY_NAME,GEN_VAL_YR,GEN_QY1_YR,UNIT_QY1"
commodity_codes = ["2615906030", "8112921000"]  # List of 10 digit HS codes


# Automatic dataframe column name creation
imp_cols = fields.split(",")
imp_cols.extend(["time","hs_extra","agg_extra"])

# Function to fetch data through API
def fetch_census_trade_data(years, commodity_codes):
    # Base URL
    url = "https://api.census.gov/data/timeseries/intltrade/imports/hs"
    all_data = []  # List to store all fetched data

    # Iterate through each year and commodity code
    for year in years:
        for commodity_code in commodity_codes:
            params = {
                "get": fields,
                "time": f"{year}-12",
                "I_COMMODITY": commodity_code,
                "SUMMARY_LVL": "DET"
            }

            try:
                response = requests.get(url, params=params)
                response.raise_for_status()
                data = response.json()
                all_data.extend(data[1:])  # Append the data excluding the header

            except requests.exceptions.HTTPError as http_err:
                print(f"HTTP error occurred for year {year} and commodity code {commodity_code}: {http_err}")
            except Exception as err:
                print(f"An error occurred for year {year} and commodity code {commodity_code}: {err}")

    return all_data

# Call function
if __name__ == "__main__":
    census_data = fetch_census_trade_data(years, commodity_codes)

    # Convert to pandas DataFrame
    df = pd.DataFrame(census_data, columns=imp_cols)
    # Drop last 2 columns, which are redundant
    df = df.iloc[:, :-2]
    df['action'] = 'imports'

# Set option to display all columns
pd.set_option('display.max_columns', None)
print(df)
